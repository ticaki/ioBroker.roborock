{"version":3,"file":"roborock_package_helper.js","sourceRoot":"","sources":["../../src/lib/roborock_package_helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { Roborock } from \"../main\";\n\nimport fs from \"fs\";\nimport JSZip from \"jszip\";\n\nexport class roborock_package_helper {\n\tadapter: Roborock;\n\n\tconstructor(adapter) {\n\t\tthis.adapter = adapter;\n\t}\n\n\tasync updateProduct(loginApi, productID, duid) {\n\t\tconst products = await loginApi.get(\"api/v3/product\");\n\t\tconst list = products.data.data.categoryDetailList;\n\n\t\tconst appPluginRequest: any = {\n\t\t\tapilevel: 99999, // sniffed 10016 and 10019 from the app but it's subject to change so we use a high number\n\t\t\tproductids: [],\n\t\t\ttype: 2,\n\t\t};\n\n\t\tconst vacuumIDs = {};\n\t\tfor (const array in list) {\n\t\t\tfor (const product in list[array][\"productList\"]) {\n\t\t\t\tconst vacuum = list[array][\"productList\"][product];\n\t\t\t\tconst productIDinPackage = this.findProductIDinPackage(productID, vacuum);\n\n\t\t\t\tif (productIDinPackage) {\n\t\t\t\t\tappPluginRequest.productids.push(vacuum.id);\n\t\t\t\t\tvacuumIDs[vacuum.id] = vacuum.model;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst packageData = await loginApi.post(\"api/v1/appplugin\", appPluginRequest);\n\n\t\tconst packages = packageData.data.data;\n\t\tfor (const rr_package in packages) {\n\t\t\tconst vacuum = vacuumIDs[packages[rr_package].productid];\n\t\t\tconst zipUrl = packages[rr_package].url;\n\t\t\tconst version = packages[rr_package].version;\n\t\t\tconst imagePath = `./images/products/${vacuum}`;\n\t\t\tconst objectPath = `Devices.${duid}.images`;\n\t\t\tconst versionFilePath = imagePath + \"/version\";\n\n\t\t\tif (!fs.existsSync(\"./lib/roborockPackage/\")) fs.mkdirSync(\"./lib/roborockPackage/\");\n\n\t\t\ttry {\n\t\t\t\t// Create missing vacuum folders\n\t\t\t\tif (!fs.existsSync(`./images/products/`)) fs.mkdirSync(`./images/products/`);\n\t\t\t\tif (!fs.existsSync(imagePath)) fs.mkdirSync(imagePath);\n\n\t\t\t\tthis.adapter.setObjectAsync(objectPath, {\n\t\t\t\t\ttype: \"folder\",\n\t\t\t\t\tcommon: {\n\t\t\t\t\t\tname: \"images\",\n\t\t\t\t\t},\n\t\t\t\t\tnative: {},\n\t\t\t\t});\n\n\t\t\t\tif (!fs.existsSync(versionFilePath)) {\n\t\t\t\t\tfs.writeFileSync(versionFilePath, \"0\");\n\t\t\t\t}\n\t\t\t\tconst currentVersion = fs.readFileSync(versionFilePath, \"utf8\");\n\n\t\t\t\tif (packages[rr_package].version > currentVersion) {\n\t\t\t\t\tthis.adapter.log.debug(`New version roborock package available: ${version}`);\n\n\t\t\t\t\tconst response = await loginApi.get(zipUrl, { responseType: \"arraybuffer\" });\n\t\t\t\t\tconst zip = await JSZip.loadAsync(response.data);\n\t\t\t\t\tconst folder = zip.folder(\"drawable-mdpi\");\n\n\t\t\t\t\tif (folder) {\n\t\t\t\t\t\tlet i = 0;\n\t\t\t\t\t\tfolder.forEach(async (relativePath, file) => {\n\t\t\t\t\t\t\tif (!file.dir) {\n\t\t\t\t\t\t\t\tconst fileContent = await file.async(\"nodebuffer\");\n\t\t\t\t\t\t\t\tif (fileContent) {\n\t\t\t\t\t\t\t\t\tfs.writeFileSync(`${imagePath}/${relativePath}`, fileContent);\n\n\t\t\t\t\t\t\t\t\tconst fileContentBase64 = fileContent.toString(\"base64\");\n\t\t\t\t\t\t\t\t\tconst fileNameWithoutExtension = relativePath.slice(0, relativePath.lastIndexOf(\".\"));\n\t\t\t\t\t\t\t\t\tconst formattedNumber = (i).toString().padStart(3, \"0\"); // \"001\", \"002\", \"003\", etc.\n\n\t\t\t\t\t\t\t\t\tthis.adapter.setObjectAsync(`${objectPath}.${formattedNumber}`, {\n\t\t\t\t\t\t\t\t\t\ttype: \"state\",\n\t\t\t\t\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\t\t\t\t\tname: fileNameWithoutExtension,\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\trole: \"value\",\n\t\t\t\t\t\t\t\t\t\t\tread: true,\n\t\t\t\t\t\t\t\t\t\t\twrite: false\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tnative: {},\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tthis.adapter.setStateAsync(`${objectPath}.${formattedNumber}`, { val: fileContentBase64, ack: true });\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ti++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tfs.writeFileSync(versionFilePath, version.toString());\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tthis.adapter.log.error(`${err.stack} roborock_package_helper.updateProduct ${productID}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tfindProductIDinPackage(productID, list) {\n\t\tif (list.model === productID) {\n\t\t\treturn list.id;\n\t\t}\n\t}\n}"]}